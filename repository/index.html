<?php

/* header í•¨ìˆ˜ëŠ” ë’¤ë¡œê°€ê¸°ì™€ ê´€ë ¨í•´ì„œ í¸ì˜ì„±ì´ ìˆìŒ. */
header('Cache-Control: no-store, no-cache, must-revalidate');
header('Cache-Control: post-check=0, pre-check=0', false);
header('Pragma: no-cache');

/******************************************************************************************
list.htmlì„ ì‹¤í–‰í•˜ì§€ ì•Šì•˜ìœ¼ë©´ ì´ ì¿ í‚¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ. 
ë°ì´í„°ë¥¼ ì—…ë¡œë“œ/ìˆ˜ì • ë“±ì€ ì´ ì¿ í‚¤ê°€ ì¡´ì¬í•˜ëŠ”ê°€? í•˜ì§€ ì•ŠëŠ”ê°€ë¥¼ ë¨¼ì € ì ê²€í•´ì•¼ í•¨.
******************************************************************************************/

setcookie('_view_list_repository0_', md5('yes'), 0, '/');
include_once '../header.inc.html';
?>

<style>
/*Setting contents: contents is a top container in the tags*/
#contents { width: 1000px; margin: 10px auto 5px auto; padding-left: calc((100vw - 100%) / 2); }
#contents a { text-decoration: none; color: rgb(30,30,30); }
#contents a:hover { text-decoration: none; color: rgb(30,30,30); font-weight: bold; }

/* Setting roomInfo: roomInfo contains in tag contents and perfomences as single */
#roomInfo { width: 100%; }
#roomInfo > #ri_left { float: left; padding: 0 2px 5px 2px; }
#roomInfo > #ri_right { float: right; padding:  0 2px 5px 2px; text-align: right; }

/* Setting List: List is a table id */
#list { width: 100%; border-collapse: collapse; table-layout: fixed; border-top: 2px solid black; border-bottom: 2px solid black; }
.th { padding: 5px; border: none; background-color: #281F1D;  color:white;}
.td { padding: 6px; border: none; border-bottom: 1px solid silver; }
.tdCenter { padding: 6px; border: none; border-bottom: 1px solid silver;  text-align: center; }
 .tdCenter > a {text-decoration:none; color:rgb(30,30,30);}
.tdEllipsis { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tdBlank { color: gray; height: 120px; }

/* Setting Tag of div pageLink: Show lower Page Number */
#pageLink { text-align: center; }
#lists_per_page { padding: 2px 1px; border:none; border-bottom: 1px solid black; background-color:rgb(250,250,250); text-align:center; width:50px; font-weight:bold; }
#etc { width:100%; display: flex; justify-content:center;}
#etc > #listCount { width: 400px; }
#etc > #upload { width: 200px; text-align: center; }
#etc > #search { width: 400px; text-align: right; }
.search { padding: 3px; }
</style>

<script>
    /**************************************************************
    *********************ë¹„ê³µê°œ íŒŒì¼ ë¡œì§ êµ¬í˜„************************
    **************************************************************/
    function ShowContent(isPrivate, table, num, page, field, val){
        if(isPrivate == 'Y'){
           var pw = prompt('ë¹„ê³µê°œ ìë£Œì…ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì‹­ì‹œì˜¤.');
           if(pw){
               var xhr= new XMLHttpRequest();
               xhr.onreadystatechange = function(){
                   if(this.readyState == 4 && this.status == 200){
                       if(this.responseText == 'OK'){
                           location.href = 'view.content.html?table=' + table + '&num=' + num + '&page=' + page + '&field=' + field + '&val=' + val;
                       }
                       else{
                           alert('ë¹„ë°€ë²ˆí˜¸ê°€  ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì‹­ì‹œì˜¤');
                       }
                   }
               };
               
               //repository0ì˜ xë²ˆí˜¸ì˜ ë¹„ë°€ë²ˆí˜¸ëŠ” ë‹¤ìŒê³¼ ê°™ìŒì„ ì „ì†¡.
               xhr.open('GET','verify.pw.php?table=' + table + '&num=' + num + '&password=' + pw,true);
               xhr.send();
           }
           else{
               return ;
           }
        }
        else{
            location.href = 'view.content.html?table=' + table + '&num=' + num + '&page=' + page + '&field=' + field + '&val=' + val;
        }
    }
    
    
    
    /*********************************************************************************
    ****************Setting view Data on the in the List on the screen****************
    **********************************************************************************/
    function SetLists(){
        var lists = document.getElementById('lists_per_page').value; //listsëŠ” í˜ì´ì§€ë‹¹ ìˆ«ì.
        var today = new Date();
        //expëŠ” ìƒˆë¡œìš´ ë‚ ì§œ. í˜„ì¬ë¡œë¶€í„° 30ì¼ ì´í›„ì˜ ë¯¸ë˜ ë‚ ì§œë¥¼ êµ¬í•¨.
        var exp = new Date(today.getTime() + 24 * 60 * 60 * 1000 * 90); 
        //ì¿ í‚¤ ì„¸íŒ…. ì¿ í‚¤ì— í˜ì´ì§€ë‹¹ ìˆ«ìë¥¼ ê°’ìœ¼ë¡œ ë„£ì–´ë‘ê³ , ë§Œë£ŒëŠ” 30ì¼ í›„ë¡œ ê¸°ì•½.
        document.cookie = 'dr_lists_per_page =' + lists + '; expires=' + exp.toUTCString();
        location.reload(); //í™”ë©´ ê°±ì‹    
    }
    
    //ê²€ìƒ‰ ìƒíƒœë¥¼ ë¹ ì ¸ ë‚˜ê°ˆ ë•Œ ê¸°ëŠ¥. ì˜ˆë¥¼ ë“¤ì–´ ê²€ìƒ‰ì˜ --------ë¥¼ ì„ íƒí•˜ë©´ index.htmlì„ ë‹¤ì‹œ ì‹¤í–‰
    
    /***********************************************************************************
    ********************This function performence for search box************************
    ***********************************************************************************/
    function SelectChanged(form){
        if (form.field.selectedIndex == 0){ //selectedIndexëŠ” ì†ì„±
            alert('ì´ˆê¸°í™”');
            /*form.val.value="";
            form.submit();*/
        }
        else{
            form.val.value = "";
            form.val.focus();
        }
    }
    
     /*
    ************************************************************************************
    ************************This function performence for Search************************
    ************************************************************************************
    */
    function Search(form){
        if (form.field.selectedIndex > 0 && form.val.value){
            form.submit();
        }
        else{
            alert('ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ì‹­ì‹œì˜¤');
        }
    }
</script>

<div id="contents">
<?php
include_once '../db.inc.php';

/* 
*********************************Setting Page State********************************
$lists_per_page = 10; //í•œ í™”ë©´ì— ë³´ì—¬ì¤„ ìˆ˜ ìˆëŠ” ëª©ë¡ì˜ ìˆ˜
$links_per_block = 15; //í˜ì´ì§€ í•œ ë¬¶ìŒì„ blockì´ë¼ê³  ì •ì˜í•¨. 
***********************************************************************************
*/


//ì¿ í‚¤ê°€ ì„¸íŒ…ë˜ì–´ ìˆë‹¤ë©´ ì¿ í‚¤ê°’, ì•„ë‹ˆë©´ lists_per_pageì˜ ê°’ì„ 10ìœ¼ë¡œ ì„¸íŒ…
$lists_per_page = isset($_COOKIE['dr_lists_per_page']) ? $_COOKIE['dr_lists_per_page'] : 5 ; 
$links_per_block = 5;  

$table = isset($_GET['table']) ? $_GET['table'] : 'repository0'; 
$board_title = 'ìë£Œì‹¤'; //í…Œì´ë¸” ì´ë¦„ì— ë”°ë¼ ë‹¤ë¥¸ ì´ë¦„ì„ ë¶€ì—¬, 

switch($table) {
  
   /********************************************************
   ********************table Setting************************
   *********************************************************/
   
    case 'repository1' : $board_title = 'ìë£Œì‹¤1'; break; 
    case 'repository2' : $board_title = 'ìë£Œì‹¤2'; break; 
}


//GETë°©ì‹ì€ ì•„ë˜ì˜ formì— ìˆëŠ” ë‚´ìš©.
$field = isset($_GET['field']) ? $_GET['field'] : '';
$val = isset($_GET['val']) ? $_GET['val'] : '';


$search = '';
$msg = 'ì „ì²´ ìë£Œìˆ˜';
if ($field || $val){
     $search= "and $field like '%$val%'"; 
     $msg = 'ê²€ìƒ‰ëœ ìë£Œìˆ˜';
}


 //í™”ë©´ì— ëª‡ í˜ì´ì§€ë¥¼ ë³´ì—¬ì¤˜ì•¼ í•˜ëŠ”ê°€?
$page = isset($_GET['page']) ? $_GET['page'] : 1;

//í–‰ ê°¯ìˆ˜ ê°€ì ¸ì˜¤ê¸°
$total_count = mysqli_fetch_row(DBQuery("select count(num) from $table where 1 $search"))[0];

//ceil í•¨ìˆ˜: í•´ë‹¹ ìˆ«ìê°€ ì†í•œ êµ¬ê°„ì˜ ì •ìˆ˜ ìµœëŒ“ê°’ ë°˜í™˜. í˜ì´ì§€ ë¸”ë¡ ìˆ«ë¥¼ êµ¬í•˜ê¸° ìœ„í•´ì„œ ì´ìš©.
$total_page = ceil($total_count / $lists_per_page);

if ($page > $total_page) {
    $page = $total_page;
}
echo $val;
?>
    <div id="roomInfo">
        <div id="ri_left">ğŸ<?=$board_title;?></div>
        <div id="ri_right">ì „ì²´ ìë£Œìˆ˜ : <strong> <?=$total_count;?> </strong> ( <strong><?=$page;?> </strong> / <?=$total_page;?> ) </div>
    </div>
    
    <table id="list">
        <tr>
            <th class="th" width="60">ìˆœë²ˆ</th>
            <th class="th">ì œëª©</th>
            <th class="th" width="120">ì˜¬ë¦°ì´</th>
            <th class="th" width="120">ë‚ ì§œ</th>
            <th class="th" width="60">ì¡°íšŒìˆ˜</th>
        </tr>
        <!--DBì—ì„œ ìë£Œë¥¼ ì „ì†¡ë°›ì•„ ì¶œë ¥...-->
        <!--ì „ì²´ í˜ì´ì§€ - (í˜„ì¬ í˜ì´ì§€-1) * í˜ì´ì§€ë‹¹ ìˆ«ì(10)-->
<?php
if ($total_count > 0) {
	$start = ($page - 1) * $lists_per_page;
	$result = DBQuery("select * from $table where 1 $search order by num desc limit $start, $lists_per_page"); //í…Œì´ë¸”ë¡œë¶€í„° ì¸ë±ìŠ¤ ê°’ì„ ì¶”ì¶œí•´ì„œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬

	$v_num = $total_count - ($page - 1) * $lists_per_page; 

/*
****************************************************************************
************************Show on the screen the Data ************************
****************************************************************************
*/

	while($row = mysqli_fetch_array($result)){
    //YëŠ” ê°œì¸ì ì¸ ìë£Œì„ì„ ì˜ë¯¸ 
	    $isPrivate = ($row['isPrivate'] == 'Y') ? "<img src='lock.png' style='height:18px; vertical-align:bottom; height:18px;'/>" :'';
	    //ëŒ“ê¸€ì´ ëª‡ ê°œë‚˜ ìˆëŠ”ì§€
	    $cmts_count = mysqli_fetch_row(DBQuery("select count(num) from {$table}_cmts where b_num = {$row['num']}"))[0];
	    
        $cmt = ($cmts_count > 0) ? "<span style='color:gray;'>[" . $cmts_count . "]</span>" : '';
		$wtime = date('Y-m-d', $row['wtime']);
		$ref = number_format($row['ref']);
		echo <<< TR
    <tr>
        <td class="tdCenter" width="60" > $v_num </td>
        
        <!--
        <td class="td tdEllipsis"><a href="view.content.html?table=$table&num={$row['num']}&page=$page&field=$field&val=$val">{$row['title']}</a>$isPrivate $cmt</td>
        -->
        
        <td class="td tdEllipsis"><a href="javascript:void(0)" onclick="ShowContent('{$row['isPrivate']}','$table',{$row['num']},$page,'$field', '$val');">{$row['title']}</a>$isPrivate $cmt</td>
        <td class="tdCenter" width="100" > {$row['name']} </td>
        <td class="tdCenter" width="100"> $wtime </td>
        <td class="tdCenter" width="60"> $ref </td>
    </tr>

TR;
		$v_num--;
	}
/* Unlock the Memory*/

	DBClose($result); 
}
else {
?>
        <tr>
            <td colspan="5" class="tdCenter tdBlank">ë“±ë¡ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</td>
        </tr>
<?php
}
?>
    </table>

<?php
   if($total_count > 0){ //ë§Œì•½ ê²Œì‹œë¬¼ì˜ ìˆ«ìê°€ 0ê°œ ì´ìƒì´ë©´ í•˜ë‹¨ í˜ì´ì§€ë¥¼ ë³´ì—¬ì¤€ë‹¤. 
?>
   <!--Show lower Page Number-->
    <div id="pageLink">
         <?php
         $block = ceil($page / $links_per_block); // í•œ í˜ì´ì§€ ë¸”ë¡ì„ ë§Œë“¤ì–´ë‚¸ë‹¤.
         // ë‹¨ìœ„ ë¸”ë¡ë‹¹ êµ¬ê°„ì˜ ì²« ë²ˆì§¸ í˜ì´ì§€ êµ¬í˜„ 1í˜ì´ì§€, 11í˜ì´ì§€, 21í˜ì´ì§€ ...
         $sp = ($block - 1) * $links_per_block + 1;
         $ep = $block * $links_per_block;
         if($ep > $total_page){
             $ep = $total_page;
         }
         
         if($block > 1){ //ë¸”ë¡ì´ 1ë³´ë‹¤ í¬ë©´
            echo "<a href='index.html?page=" . ($sp - 1) . "&fiel$field&val=$val'> ì´ì „ </a>&nbsp"; //ì´ì „ ë¸”ë¡ìœ¼ë¡œ ë³´ë‚´ê¸°    
         }
             
    /*
        ****************************************************************************
        *************perfomence to show on the Screen the number *******************
        ****************************************************************************
    */
         for($p = $sp; $p <= $ep; $p++){
                 if($p == $page){
                  echo "<span style='color:rgb(30,30,30); font-weight:bold;'> $p </span>&nbsp;";
                 }else
                 {
                   echo "<a href='index.html?page=$p&fiel$field&val=$val'>$p</a>&nbsp;";
                 }
                     
            
         }
                 if($total_page > $ep){
                    echo "<a href= 'index.html?page=" . ($ep + 1) . "&fiel$field&val=$val'>ë‹¤ìŒ</a>";
                 }
     ?>
        
<?php
}
?>
    </div>
    <div id="etc">
        <div id="listCount">
            í™”ë©´ë‹¹ ëª©ë¡ìˆ˜
            <!--
            onChange="SetLists()ì€ ë‚´ìš©ë¬¼ì´ ë³€ê²½ì´ ëœë‹¤ë©´, SetListsë¼ëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œ.
            ì¿ í‚¤ë¥¼ ë“±ë¡í•´ë†“ê³  í™”ë©´ ê°±ì‹ ì„ í•˜ë ¤ëŠ” ì‹œë„.
            -->
            <input id = "lists_per_page" type="number" value="<?=$lists_per_page;?>" min="1" max="100" onchange="SetLists();"> 
        </div>
        <div id="upload"><a href="data.upload.html?table=<?=$table;?>">ì—…ë¡œë“œ</a></div>
        <div id="search">
           <!-- í˜ì´ì§€ë‚˜ ê²€ìƒ‰ì´ë‚˜ ëª¨ë‘ í•œ ë°©ì‹ìœ¼ë¡œ í†µì¼. ì—¬ê¸°ì„œëŠ” getë°©ì‹-->
            <form method="get"> 
                <input type="text" name="val" value="<?=$val;?>" size="15" style="padding: 3px; border:none; border-bottom: 1px solid black; background-color:rgb(250,250,250)">
                    <select name="field" style="padding:3px; width:80px;" onchange="SelectChanged(this.form);">
                        <option value="">---------</option>
                        <option value="title" <?=($field == 'title') ? 'selected' : '';?>>ì œëª©</option>

                        <option value="content" <?=($field == 'content') ? 'selected' : '';?>>ë‚´ìš©</option>
                        <option value="name" <?=($field == 'name') ? 'selected' : '';?>>ì˜¬ë¦°ì´</option>
                        <option value="file" <?=($field == 'file') ? 'selected' : '';?>>íŒŒì¼ ì´ë¦„</option>
                    </select>
                <input type="button" value="í™•ì¸" onclick="Search(this.form);" style="padding:0 6px; cursor:pointer;">
            </form>
        </div>
    </div>
</div>

<?php
include_once '../footer.inc.html';
?> 